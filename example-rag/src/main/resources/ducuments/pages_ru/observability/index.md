# Наблюдаемость

Spring AI основывается на функциях наблюдаемости в экосистеме Spring, чтобы предоставить информацию о связанных с ИИ операциях.

Модуль spring-boot-actuator необходим для включения наблюдаемости.
Добавьте зависимость Spring Boot Actuator в файл сборки Maven `pom.xml` вашего проекта:

```xml
<dependency>
 <groupId>org.springframework.boot</groupId>
 <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

или в файл сборки Gradle `build.gradle`.

```groovy
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
}
```

Spring AI предоставляет возможности метрик и трассировки для своих основных компонентов: `ChatClient` (включая `Advisor`),
`ChatModel`, `EmbeddingModel`, `ImageModel` и `VectorStore`.

> **Примечание:** К метрикам и трассам будут добавлены ключи с низкой кардинальностью, в то время как ключи с высокой кардинальностью будут добавлены только к трассам.

[WARNING]
====
**1.0.0-RC1 Ломающие изменения** 

Следующие свойства конфигурации были переименованы для лучшего отражения их назначения:

- `spring.ai.chat.client.observations.include-prompt` → `spring.ai.chat.client.observations.log-prompt`
- `spring.ai.chat.observations.include-prompt` → `spring.ai.chat.observations.log-prompt`
- `spring.ai.chat.observations.include-completion` → `spring.ai.chat.observations.log-completion`
- `spring.ai.image.observations.include-prompt` → `spring.ai.image.observations.log-prompt`
- `spring.ai.vectorstore.observations.include-query-response` → `spring.ai.vectorstore.observations.log-query-response`
====

## Клиент Чата

Наблюдения `spring.ai.chat.client` записываются, когда вызываются операции `call()` или `stream()` ChatClient. 
Они измеряют время, затраченное на выполнение вызова, и передают связанную информацию о трассировке.

.Низкие кардинальные ключи
| Имя | Описание |
| --- | --- |
| `gen_ai.operation.name` | Всегда `framework`. |
| `gen_ai.system` | Всегда `spring_ai`. |
| `spring.ai.chat.client.stream` | Является ли ответ модели чата потоком - `true или false` |
| `spring.ai.kind` | Вид API фреймворка в Spring AI: `chat_client`. |

.Высокие кардинальные ключи
| Имя | Описание |
| --- | --- |
| `gen_ai.prompt` | Содержимое запроса, отправленного через клиент чата. Необязательно. |
| `spring.ai.chat.client.advisor.params` (устарело) | Карта параметров советника. Идентификатор разговора теперь включен в `spring.ai.chat.client.conversation.id`. |
| `spring.ai.chat.client.advisors` | Список настроенных советников клиента чата. |
| `spring.ai.chat.client.conversation.id` | Идентификатор разговора при использовании памяти чата. |
| `spring.ai.chat.client.system.params` (устарело) | Параметры системы клиента чата. Необязательно. Заменено на `gen_ai.prompt`. |
| `spring.ai.chat.client.system.text` (устарело) | Текст системы клиента чата. Необязательно. Заменено на `gen_ai.prompt`. |
| `spring.ai.chat.client.tool.function.names` (устарело) | Имена включенных функций инструментов. Заменено на `spring.ai.chat.client.tool.names`. |
| `spring.ai.chat.client.tool.function.callbacks` (устарело) | Список настроенных обратных вызовов функций клиента чата. Заменено на `spring.ai.chat.client.tool.names`. |
| `spring.ai.chat.client.tool.names` | Имена инструментов, переданных клиенту чата. |
| `spring.ai.chat.client.user.params` (устарело) | Параметры пользователя клиента чата. Необязательно. Заменено на `gen_ai.prompt`. |
| `spring.ai.chat.client.user.text` (устарело) | Текст пользователя клиента чата. Необязательно. Заменено на `gen_ai.prompt`. |

### Данные о запросах и завершениях```
Данные о запросах и ответах `ChatClient` обычно большие и могут содержать конфиденциальную информацию. 
По этим причинам они не экспортируются по умолчанию.

Spring AI поддерживает ведение журнала данных о запросах и ответах для помощи в отладке и устранении неполадок.

| Свойство | Описание | По умолчанию |
| --- | --- | --- |

| `spring.ai.chat.client.observations.log-prompt` | Включить ли ведение журнала содержимого запроса клиента чата. | `false` |
| --- | --- | --- |
| `spring.ai.chat.client.observations.log-completion` | Включить ли ведение журнала содержимого ответа клиента чата. | `false` |

> **Внимание:** Если вы включите ведение журнала данных о запросах и ответах клиента чата, существует риск раскрытия конфиденциальной или личной информации. Пожалуйста, будьте осторожны!

### Входные данные (Устарело)

> **Внимание:** Свойство `spring.ai.chat.client.observations.include-input` устарело, заменено на `spring.ai.chat.client.observations.log-prompt`. См. xref:_prompt_content[Содержимое запроса].

Входные данные `ChatClient` обычно большие и могут содержать конфиденциальную информацию. 
По этим причинам они не экспортируются по умолчанию.

Spring AI поддерживает ведение журнала входных данных для помощи в отладке и устранении неполадок.

| Свойство | Описание | По умолчанию |
| --- | --- | --- |

| `spring.ai.chat.client.observations.include-input` | Включить ли содержимое входных данных в наблюдения. | `false` |
| --- | --- | --- |

> **Внимание:** Если вы включите включение содержимого входных данных в наблюдения, существует риск раскрытия конфиденциальной или личной информации. Пожалуйста, будьте осторожны!

### Консультанты клиента чата

Наблюдения `spring.ai.advisor` записываются, когда выполняется консультант. 
Они измеряют время, затраченное на консультанта (включая время, затраченное на внутренних консультантов), и передают связанную информацию о трассировке.

.Низкая кардинальность ключей
| Название | Описание |
| --- | --- |
| `gen_ai.operation.name` | Всегда `framework`. |
| `gen_ai.system` | Всегда `spring_ai`. |
| `spring.ai.advisor.type` (устарело) | Где консультант применяет свою логику в обработке запроса, один из `BEFORE`, `AFTER` или `AROUND`. Это различие больше не применяется, так как все консультанты всегда одного типа. |
| `spring.ai.kind` | Вид API фреймворка в Spring AI: `advisor`. |

.Высокая кардинальность ключей
| Название | Описание |
| --- | --- |
| `spring.ai.advisor.name` | Имя консультанта. |
| `spring.ai.advisor.order` | Порядок консультанта в цепочке консультантов. |

## Модель чата
```> **Примечание:** Функции наблюдаемости в настоящее время поддерживаются только для реализаций `ChatModel` от следующих поставщиков AI-моделей: Anthropic, Azure OpenAI, Mistral AI, Ollama, OpenAI, Vertex AI, MiniMax, Moonshot, QianFan, Zhipu AI. Дополнительные поставщики AI-моделей будут поддержаны в будущих релизах.

Наблюдения `gen_ai.client.operation` записываются при вызове методов `call` или `stream` ChatModel. Они измеряют время, затраченное на завершение метода, и передают соответствующую информацию для трассировки.

> **Важно:** Метрики `gen_ai.client.token.usage` измеряют количество входных и выходных токенов, использованных при одном вызове модели.

.Low Cardinality Keys
| Название | Описание |
| --- | --- |
| `gen_ai.operation.name` | Название выполняемой операции. |
| `gen_ai.system` | Поставщик модели, определенный клиентской инструментировкой. |
| `gen_ai.request.model` | Название модели, к которой делается запрос. |
| `gen_ai.response.model` | Название модели, сгенерировавшей ответ. |

.High Cardinality Keys
| Название | Описание |
| --- | --- |
| `gen_ai.request.frequency_penalty` | Настройка штрафа за частоту для запроса модели. |
| `gen_ai.request.max_tokens` | Максимальное количество токенов, которые модель генерирует для запроса. |
| `gen_ai.request.presence_penalty` | Настройка штрафа за присутствие для запроса модели. |
| `gen_ai.request.stop_sequences` | Список последовательностей, которые модель будет использовать для остановки генерации дальнейших токенов. |
| `gen_ai.request.temperature` | Настройка температуры для запроса модели. |
| `gen_ai.request.top_k` | Настройка выборки top_k для запроса модели. |
| `gen_ai.request.top_p` | Настройка выборки top_p для запроса модели. |
| `gen_ai.response.finish_reasons` | Причины, по которым модель остановила генерацию токенов, соответствующие каждому полученному результату. |
| `gen_ai.response.id` | Уникальный идентификатор для ответа AI. |
| `gen_ai.usage.input_tokens` | Количество токенов, использованных в вводе модели (подсказке). |
| `gen_ai.usage.output_tokens` | Количество токенов, использованных в выводе модели (завершении). |
| `gen_ai.usage.total_tokens` | Общее количество токенов, использованных в обмене с моделью. |
| `gen_ai.prompt` | Полная подсказка, отправленная модели. Необязательно. |
| `gen_ai.completion` | Полный ответ, полученный от модели. Необязательно. |
| `spring.ai.model.request.tool.names` | Список определений инструментов, предоставленных модели в запросе. |

> **Примечание:** Для измерения пользовательских токенов в предыдущей таблице перечислены значения, присутствующие в трассировке наблюдений. Используйте имя метрики `gen_ai.client.token.usage`, которое предоставляется `ChatModel`.

### Данные о подсказках и завершениях чата

Данные о подсказках и завершениях чата обычно большие и могут содержать конфиденциальную информацию. По этим причинам они не экспортируются по умолчанию.

Spring AI поддерживает ведение журнала данных о подсказках и завершениях чата, что полезно для сценариев устранения неполадок. Когда трассировка доступна, журналы будут включать информацию о трассировке для лучшей корреляции.

| Свойство | Описание | По умолчанию |
| --- | --- | --- |

| `spring.ai.chat.observations.log-prompt` | Вести журнал содержимого подсказки. `true` или `false` | `false` |
| --- | --- | --- |
| `spring.ai.chat.observations.log-completion` | Вести журнал содержимого завершения. `true` или `false` | `false` |
| `spring.ai.chat.observations.include-error-logging` | Включить ведение журнала ошибок в наблюдениях. `true` или `false` | `false` |

> **Внимание:** Если вы включите ведение журнала данных о подсказках и завершениях чата, существует риск раскрытия конфиденциальной или личной информации. Пожалуйста, будьте осторожны!

## Вызов инструмента```
Наблюдения `spring.ai.tool` записываются при выполнении вызова инструмента в контексте взаимодействия с моделью чата. Они измеряют время, затраченное на завершение вызова инструмента, и передают связанную информацию трассировки.

.Low Cardinality Keys
| Название | Описание |
| --- | --- |
| `gen_ai.operation.name` | Название выполняемой операции. Всегда `framework`. |
| `gen_ai.system` | Провайдер, ответственный за операцию. Всегда `spring_ai`. |
| `spring.ai.kind` | Вид операции, выполняемой Spring AI. Всегда `tool_call`. |
| `spring.ai.tool.definition.name` | Название инструмента. |

.High Cardinality Keys
| Название | Описание |
| --- | --- |
| `spring.ai.tool.definition.description` | Описание инструмента. |
| `spring.ai.tool.definition.schema` | Схема параметров, используемых для вызова инструмента. |
| `spring.ai.tool.call.arguments` | Входные аргументы для вызова инструмента. (Только при включении) |
| `spring.ai.tool.call.result` | Схема параметров, используемых для вызова инструмента. (Только при включении) |

### Аргументы вызова инструмента и данные результата

Входные аргументы и результат вызова инструмента по умолчанию не экспортируются, так как они могут быть потенциально конфиденциальными.

Spring AI поддерживает экспорт аргументов вызова инструмента и данных результата в качестве атрибутов спана.

| Свойство | Описание | По умолчанию |
| --- | --- | --- |

| `spring.ai.tools.observations.include-content` | Включить содержимое вызова инструмента в наблюдения. `true` или `false` | `false` |
| --- | --- | --- |

> **Внимание:** Если вы включите добавление аргументов вызова инструмента и результата в наблюдения, существует риск раскрытия конфиденциальной или личной информации. Пожалуйста, будьте осторожны!

## EmbeddingModel

> **Примечание:** Функции наблюдаемости в настоящее время поддерживаются только для реализаций `EmbeddingModel` от следующих провайдеров AI: Azure OpenAI, Mistral AI, Ollama и OpenAI. Дополнительные провайдеры AI будут поддерживаться в будущих релизах.

Наблюдения `gen_ai.client.operation` записываются при вызовах методов модели встраивания. Они измеряют время, затраченное на завершение метода, и передают связанную информацию трассировки.

> **Важно:** Метрика `gen_ai.client.token.usage` измеряет количество входных и выходных токенов, использованных в одном вызове модели.

.Low Cardinality Keys
| Название | Описание |
| --- | --- |
| `gen_ai.operation.name` | Название выполняемой операции. |
| `gen_ai.system` | Провайдер модели, определяемый инструментированием клиента. |
| `gen_ai.request.model` | Название модели, к которой делается запрос. |
| `gen_ai.response.model` | Название модели, сгенерировавшей ответ. |

.High Cardinality Keys
| Название | Описание |
| --- | --- |
| `gen_ai.request.embedding.dimensions` | Количество измерений, которые имеют результирующие выходные встраивания. |
| `gen_ai.usage.input_tokens` | Количество токенов, использованных в входных данных модели. |
| `gen_ai.usage.total_tokens` | Общее количество токенов, использованных в обмене с моделью. |

> **Примечание:** Для измерения пользовательских токенов в предыдущей таблице перечислены значения, присутствующие в трассировке наблюдения. Используйте имя метрики `gen_ai.client.token.usage`, предоставляемое `EmbeddingModel`.

## Модель изображения
```> **Примечание:** Функции наблюдаемости в настоящее время поддерживаются только для реализаций `ImageModel` от следующих поставщиков AI-моделей: OpenAI. В будущих релизах будут поддерживаться дополнительные поставщики AI-моделей.

Наблюдения `gen_ai.client.operation` фиксируются при вызовах методов модели изображения. Они измеряют время, затраченное на завершение метода, и передают связанную информацию о трассировке.

> **Важно:** Метрики `gen_ai.client.token.usage` измеряют количество входных и выходных токенов, использованных в одном вызове модели.

.Low Cardinality Keys
| Название | Описание |
| --- | --- |
| `gen_ai.operation.name` | Название выполняемой операции. |
| `gen_ai.system` | Поставщик модели, определенный клиентской инструментировкой. |
| `gen_ai.request.model` | Название модели, к которой делается запрос. |

.High Cardinality Keys
| Название | Описание |
| --- | --- |
| `gen_ai.request.image.response_format` | Формат, в котором возвращается сгенерированное изображение. |
| `gen_ai.request.image.size` | Размер изображения для генерации. |
| `gen_ai.request.image.style` | Стиль изображения для генерации. |
| `gen_ai.response.id` | Уникальный идентификатор для ответа AI. |
| `gen_ai.response.model` | Название модели, которая сгенерировала ответ. |
| `gen_ai.usage.input_tokens` | Количество токенов, использованных в вводе модели (подсказке). |
| `gen_ai.usage.output_tokens` | Количество токенов, использованных в выводе модели (генерации). |
| `gen_ai.usage.total_tokens` | Общее количество токенов, использованных в обмене с моделью. |
| `gen_ai.prompt` | Полная подсказка, отправленная модели. Необязательно. |

> **Примечание:** Для измерения пользовательских токенов в предыдущей таблице перечислены значения, присутствующие в трассировке наблюдений. Используйте имя метрики `gen_ai.client.token.usage`, предоставляемое `ImageModel`.

### Данные изображения подсказки

Данные изображения подсказки обычно большие и могут содержать конфиденциальную информацию. По этим причинам они не экспортируются по умолчанию.

Spring AI поддерживает ведение журнала данных изображения подсказки, что полезно для сценариев устранения неполадок. Когда трассировка доступна, журналы будут включать информацию о трассировке для лучшей корреляции.

| Свойство | Описание | По умолчанию |
| --- | --- | --- |
| `spring.ai.image.observations.log-prompt` | Вести журнал содержимого изображения подсказки. `true` или `false` | `false` |

> **Внимание:** Если вы включите ведение журнала данных изображения подсказки, существует риск раскрытия конфиденциальной или личной информации. Пожалуйста, будьте осторожны!

## Векторные хранилищаВсе реализации векторных хранилищ в Spring AI оснащены инструментами для предоставления метрик и данных распределенного трассирования через Micrometer.

Наблюдения `db.vector.client.operation` записываются при взаимодействии с Векторным Хранилищем. Они измеряют время, затраченное на операции `query`, `add` и `remove`, и передают связанную информацию о трассировке.

.Low Cardinality Keys
| Название | Описание |
| --- | --- |
| `db.operation.name` | Название выполняемой операции или команды. Одна из `add`, `delete` или `query`. |
| `db.system` | Продукт системы управления базами данных (СУБД), определяемый клиентским инструментированием. Один из `pg_vector`, `azure`, `cassandra`, `chroma`, `elasticsearch`, `milvus`, `neo4j`, `opensearch`, `qdrant`, `redis`, `typesense`, `weaviate`, `pinecone`, `oracle`, `mongodb`, `gemfire`, `hana`, `simple`. |
| `spring.ai.kind` | Тип API фреймворка в Spring AI: `vector_store`. |

.High Cardinality Keys
| Название | Описание |
| --- | --- |
| `db.collection.name` | Название коллекции (таблицы, контейнера) в базе данных. |
| `db.namespace` | Название базы данных, полностью квалифицированное в пределах адреса сервера и порта. |
| `db.record.id` | Идентификатор записи, если он присутствует. |
| `db.search.similarity_metric` | Метрика, используемая в поиске по сходству. |
| `db.vector.dimension_count` | Размерность вектора. |
| `db.vector.field_name` | Название поля вектора (например, имя поля). |
| `db.vector.query.content` | Содержимое выполняемого поискового запроса. |
| `db.vector.query.filter` | Метаданные фильтры, используемые в поисковом запросе. |
| `db.vector.query.response.documents` | Возвращенные документы из запроса на поиск по сходству. Необязательно. |
| `db.vector.query.similarity_threshold` | Порог сходства, который принимает все оценки поиска. Значение порога 0.0 означает, что принимается любое сходство или отключается фильтрация по порогу сходства. Значение порога 1.0 означает, что требуется точное совпадение. |
| `db.vector.query.top_k` | Топ-k наиболее похожих векторов, возвращаемых запросом. |


### Данные ответа

Данные ответа на векторный поиск обычно большие и могут содержать конфиденциальную информацию. По этим причинам они не экспортируются по умолчанию.

Spring AI поддерживает ведение журнала данных ответа на векторный поиск, что полезно для сценариев устранения неполадок. Когда трассировка доступна, журналы будут включать информацию о трассировке для лучшей корреляции.

| Свойство | Описание | По умолчанию |
| --- | --- | --- |
| `spring.ai.vectorstore.observations.log-query-response` | Вести журнал содержимого ответа на запрос векторного хранилища. `true` или `false` | `false` |

> **Внимание:** Если вы включите ведение журнала данных ответа на векторный поиск, существует риск раскрытия конфиденциальной или личной информации. Пожалуйста, будьте осторожны!

## Справочник по метрикам

Этот раздел документирует метрики, генерируемые компонентами Spring AI, как они появляются в Prometheus.

### Конвенции именования метрик

Spring AI использует Micrometer. Базовые имена метрик используют точки (например, `gen_ai.client.operation`), которые Prometheus экспортирует с подчеркиваниями и стандартными суффиксами:

- **Таймеры** → `<base>_seconds_count`, `<base>_seconds_sum`, `<base>_seconds_max`, и (когда поддерживается) `<base>_active_count`
- **Счетчики** → `<base>_total` (монотонные)

[NOTE]
====
Следующее показывает, как базовые имена метрик расширяются в временные ряды Prometheus.

| Базовое имя метрики | Экспортируемые временные ряды |
| --- | --- |
| `gen_ai.client.operation` |  |
| `db.vector.client.operation` |  |
====

#### Ссылки

- OpenTelemetry — https://opentelemetry.io/docs/specs/semconv/gen-ai/[Семантические конвенции для генеративного ИИ (обзор)]
- Micrometer — https://docs.micrometer.io/micrometer/reference/concepts/naming.html[Именование метрик]

### Метрики клиента чата
| Название метрики | Тип | Единица | Описание |
| --- | --- | --- | --- |
| `gen_ai_chat_client_operation_seconds_sum` |  |  |  |
| Таймер |  |  |  |
| секунды |  |  |  |
| Общее время, затраченное на операции ChatClient (вызов/поток) |  |  |  |
| `gen_ai_chat_client_operation_seconds_count` |  |  |  |
| Счетчик |  |  |  |
| количество |  |  |  |
| Количество завершенных операций ChatClient |  |  |  |
| `gen_ai_chat_client_operation_seconds_max` |  |  |  |
| Датчик |  |  |  |
| секунды |  |  |  |
| Максимальная наблюдаемая продолжительность операций ChatClient |  |  |  |
| `gen_ai_chat_client_operation_active_count` |  |  |  |
| Датчик |  |  |  |
| количество |  |  |  |
| Количество операций ChatClient, находящихся в процессе выполнения |  |  |  |

**Активные против Завершенных**: `**_active_count` показывает текущие вызовы; серия `_seconds_**` отражает только завершенные вызовы.

### Метрики модели чата (выполнение поставщика модели)

| Название метрики | Тип | Единица | Описание |
| --- | --- | --- | --- |
| `gen_ai_client_operation_seconds_sum` |  |  |  |
| Таймер |  |  |  |
| секунды |  |  |  |
| Общее время выполнения операций модели чата |  |  |  |
| `gen_ai_client_operation_seconds_count` |  |  |  |
| Счетчик |  |  |  |
| количество |  |  |  |
| Количество завершенных операций модели чата |  |  |  |
| `gen_ai_client_operation_seconds_max` |  |  |  |
| Датчик |  |  |  |
| секунды |  |  |  |
| Максимальная наблюдаемая продолжительность операций модели чата |  |  |  |
| `gen_ai_client_operation_active_count` |  |  |  |
| Датчик |  |  |  |
| количество |  |  |  |
| Количество операций модели чата, находящихся в процессе выполнения |  |  |  |

#### Использование токенов

| Название метрики | Тип | Единица | Описание |
| --- | --- | --- | --- |
| `gen_ai_client_token_usage_total` |  |  |  |
| Счетчик |  |  |  |
| токены |  |  |  |
| Общее количество использованных токенов, помеченных по типу токена |  |  |  |

#### Метки

| Метка | Значение |
| --- | --- |
| `gen_ai_token_type=input` | Токены запроса, отправленные модели |
| `gen_ai_token_type=output` | Токены завершения, возвращенные моделью |
| `gen_ai_token_type=total` | Входные + выходные |

### Метрики хранилища векторов

| Название метрики | Тип | Единица | Описание |
| --- | --- | --- | --- |
| `db_vector_client_operation_seconds_sum` |  |  |  |
| Таймер |  |  |  |
| секунды |  |  |  |
| Общее время, затраченное на операции хранилища векторов (добавление/удаление/запрос) |  |  |  |
| `db_vector_client_operation_seconds_count` |  |  |  |
| Счетчик |  |  |  |
| количество |  |  |  |
| Количество завершенных операций хранилища векторов |  |  |  |
| `db_vector_client_operation_seconds_max` |  |  |  |
| Датчик |  |  |  |
| секунды |  |  |  |
| Максимальная наблюдаемая продолжительность операций хранилища векторов |  |  |  |
| `db_vector_client_operation_active_count` |  |  |  |
| Датчик |  |  |  |
| количество |  |  |  |
| Количество операций хранилища векторов, находящихся в процессе выполнения |  |  |  |

#### Метки

| Метка | Значение |
| --- | --- |
| `db_operation_name` | Тип операции (`add`, `delete`, `query`) |
| `db_system` | Векторная БД/поставщик (`redis`, `chroma`, `pgvector`, …) |
| `spring_ai_kind` | `vector_store` |

### Понимание Активных и Завершенных

- **Активные (`*_active_count`)** — мгновенный датчик текущих операций (конкуренция/нагрузка).
- **Завершенные (`*_seconds_sum|count|max`)** — статистика для завершенных операций:
- `_seconds_sum / _seconds_count` → средняя задержка
- `_seconds_max` → максимальное значение с последнего сбора (в зависимости от поведения реестра)

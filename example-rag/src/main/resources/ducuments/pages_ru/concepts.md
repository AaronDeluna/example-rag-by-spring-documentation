[[concepts]]
# AI Concepts

В этом разделе описаны основные концепции, которые использует Spring AI. Мы рекомендуем внимательно прочитать его, чтобы понять идеи, лежащие в основе реализации Spring AI.

## Models

AI модели — это алгоритмы, предназначенные для обработки и генерации информации, часто имитирующие когнитивные функции человека. Изучая паттерны и инсайты из больших наборов данных, эти модели могут делать прогнозы, генерировать текст, изображения или другие выходные данные, улучшая различные приложения в разных отраслях.

Существует множество различных типов AI моделей, каждая из которых подходит для конкретного случая использования. В то время как ChatGPT и его возможности генеративного ИИ завоевали внимание пользователей благодаря вводу и выводу текста, многие модели и компании предлагают разнообразные входные и выходные данные. До появления ChatGPT многие люди были очарованы моделями генерации изображений из текста, такими как Midjourney и Stable Diffusion.

Следующая таблица классифицирует несколько моделей на основе типов их входных и выходных данных:

![Model types, width=600, align="center"](spring-ai-concepts-model-types.jpg)

Spring AI в настоящее время поддерживает модели, которые обрабатывают входные и выходные данные в виде языка, изображения и аудио. Последняя строка в предыдущей таблице, которая принимает текст в качестве входных данных и выдает числа, более известна как встраивание текста и представляет собой внутренние структуры данных, используемые в модели ИИ. Spring AI поддерживает встраивания для обеспечения более сложных случаев использования.

Что отличает такие модели, как GPT, так это их предобученная природа, как указано в "P" в GPT — Chat Generative Pre-trained Transformer. Эта функция предобучения превращает ИИ в универсальный инструмент для разработчиков, который не требует обширных знаний в области машинного обучения или обучения моделей.

## Prompts

Подсказки служат основой для языковых входных данных, которые направляют модель ИИ на создание конкретных выходных данных. Для тех, кто знаком с ChatGPT, подсказка может показаться просто текстом, введенным в диалоговое окно, которое отправляется в API. Однако это охватывает гораздо больше, чем просто строку.

API ChatGPT имеет несколько текстовых входов в рамках одной подсказки, при этом каждому текстовому входу назначается роль. Например, есть роль системы, которая говорит модели, как себя вести и устанавливает контекст для взаимодействия. Также есть роль пользователя, которая обычно представляет собой ввод от пользователя.

Создание эффективных подсказок — это и искусство, и наука. ChatGPT был разработан для человеческих разговоров. Это довольно отличается от использования чего-то вроде SQL для "задачи вопроса". Необходимо общаться с моделью ИИ так, как будто вы разговариваете с другим человеком.

Такова важность этого стиля взаимодействия, что термин "Prompt Engineering" стал отдельной дисциплиной. Существует растущее количество техник, которые улучшают эффективность подсказок. Инвестирование времени в создание подсказки может значительно улучшить полученные выходные данные.

Обмен подсказками стал общепринятой практикой, и в этой области активно ведутся академические исследования. В качестве примера того, насколько контринтуитивным может быть создание эффективной подсказки (например, в контексте SQL), недавняя https://arxiv.org/abs/2205.11916[научная работа] показала, что одна из самых эффективных подсказок, которую вы можете использовать, начинается с фразы: "`Сделайте глубокий вдох и работайте над этим шаг за шагом.`" Это должно дать вам представление о том, почему язык так важен. Мы еще не полностью понимаем, как максимально эффективно использовать предыдущие итерации этой технологии, такие как ChatGPT 3.5, не говоря уже о новых версиях, которые разрабатываются.

### Prompt TemplatesСоздание эффективных подсказок включает в себя установление контекста запроса и замену частей запроса значениями, специфичными для ввода пользователя.

Этот процесс использует традиционные текстовые шаблонные движки для создания и управления подсказками. Spring AI использует библиотеку OSS https://www.stringtemplate.org/[StringTemplate] для этой цели.

Например, рассмотрим простой шаблон подсказки:

```
Скажи мне {adjective} шутку о {content}.
```

В Spring AI шаблоны подсказок можно сравнить с "Представлением" в архитектуре Spring MVC. Объект модели, обычно `java.util.Map`, предоставляется для заполнения заполнителей внутри шаблона. "Сгенерированная" строка становится содержимым подсказки, передаваемой модели ИИ.

Существует значительная изменчивость в конкретном формате данных подсказки, отправляемой модели. Изначально начинавшись как простые строки, подсказки эволюционировали, чтобы включать несколько сообщений, где каждая строка в каждом сообщении представляет собой отдельную роль для модели.

## Встраивания

Встраивания — это числовые представления текста, изображений или видео, которые захватывают отношения между входными данными.

Встраивания работают, преобразуя текст, изображения и видео в массивы чисел с плавающей запятой, называемые векторами. Эти векторы предназначены для захвата смысла текста, изображений и видео. Длина массива встраивания называется размерностью вектора.

Путем вычисления числового расстояния между векторными представлениями двух фрагментов текста приложение может определить схожесть между объектами, использованными для генерации векторных встраиваний.

![Встраивания, width=900, align="center"](spring-ai-embeddings.jpg)

Как разработчику на Java, изучающему ИИ, не обязательно понимать сложные математические теории или конкретные реализации этих векторных представлений. Достаточно базового понимания их роли и функции в системах ИИ, особенно когда вы интегрируете функции ИИ в свои приложения.

Встраивания особенно актуальны в практических приложениях, таких как паттерн Retrieval Augmented Generation (RAG). Они позволяют представлять данные в виде точек в семантическом пространстве, что похоже на 2-D пространство евклидовой геометрии, но в более высоких измерениях. Это означает, что, как точки на плоскости в евклидовой геометрии могут быть близки или далеки в зависимости от их координат, в семантическом пространстве близость точек отражает схожесть в значении. Предложения на схожие темы располагаются ближе друг к другу в этом многомерном пространстве, подобно тому, как точки находятся близко друг к другу на графике. Эта близость помогает в таких задачах, как классификация текста, семантический поиск и даже рекомендации продуктов, так как позволяет ИИ различать и группировать связанные концепции на основе их "расположения" в этом расширенном семантическом ландшафте.

Вы можете представить это семантическое пространство как вектор.

## ТокеныTokens служат строительными блоками работы модели ИИ. На входе модели преобразуют слова в токены. На выходе они преобразуют токены обратно в слова.

На английском языке один токен примерно соответствует 75% слова. Для справки, полные произведения Шекспира, состоящие примерно из 900,000 слов, переводятся в приблизительно 1.2 миллиона токенов.

![Tokens, width=600, align="center"](spring-ai-concepts-tokens.png)

Возможно, более важно то, что Токены = Деньги. В контексте размещенных моделей ИИ ваши расходы определяются количеством использованных токенов. Как входные, так и выходные данные вносят вклад в общее количество токенов.

Кроме того, модели подвержены ограничениям по токенам, которые ограничивают объем текста, обрабатываемого за один вызов API. Этот порог часто называют "контекстным окном". Модель не обрабатывает текст, который превышает этот лимит.

Например, у ChatGPT3 есть лимит в 4K токенов, в то время как GPT4 предлагает различные варианты, такие как 8K, 16K и 32K. Модель ИИ Claude от Anthropic имеет лимит в 100K токенов, а недавние исследования Meta привели к модели с лимитом в 1M токенов.

Чтобы обобщить собранные произведения Шекспира с помощью GPT4, вам нужно разработать стратегии программной инженерии для разбивки данных и представления их в пределах лимитов контекстного окна модели. Проект Spring AI помогает вам в этой задаче.

## Структурированный вывод

Вывод моделей ИИ традиционно приходит в виде `java.lang.String`, даже если вы просите ответ в формате JSON. Это может быть корректный JSON, но это не структура данных JSON. Это просто строка. Также просьба "`о JSON`" как часть запроса не является на 100% точной.

Эта сложность привела к возникновению специализированной области, связанной с созданием запросов для получения желаемого вывода, а затем преобразованием полученной простой строки в используемую структуру данных для интеграции в приложение.

![Структурированный конвертер вывода, width=800, align="center"](structured-output-architecture.jpg)

Конверсия структурированного вывода xref:api/structured-output-converter.adoc#_structuredoutputconverter[использует тщательно разработанные запросы, часто требующие нескольких взаимодействий с моделью для достижения желаемого формата].

## Подключение ваших данных и API к модели ИИ

Как вы можете оснастить модель ИИ информацией, на которой она не была обучена?

Обратите внимание, что набор данных GPT 3.5/4.0 охватывает только период до сентября 2021 года. Следовательно, модель говорит, что не знает ответа на вопросы, требующие знаний за пределами этой даты. Интересный факт: этот набор данных составляет около 650 ГБ.

Существуют три техники для настройки модели ИИ с учетом ваших данных:

- **Тонкая настройка**: Эта традиционная техника машинного обучения включает в себя настройку модели и изменение ее внутренних весов. Однако это сложный процесс для экспертов в области машинного обучения и крайне ресурсоемкий для таких моделей, как GPT, из-за их размера. Кроме того, некоторые модели могут не предлагать эту опцию.

- **Заполнение запроса**: Более практичная альтернатива включает в себя встраивание ваших данных в запрос, предоставленный модели. Учитывая лимиты токенов модели, требуются техники для представления соответствующих данных в пределах контекстного окна модели. Этот подход в разговорной речи называется "`заполнение запроса.`" Библиотека Spring AI помогает вам реализовать решения на основе техники "`заполнения запроса`", также известной как xref::concepts.adoc#concept-rag[Увеличенное поколение с использованием извлечения (RAG)].

![Заполнение запроса, width=700, align="center"](spring-ai-prompt-stuffing.jpg)

- **xref::concepts.adoc#concept-fc[Вызов инструментов]**: Эта техника позволяет регистрировать инструменты (пользовательские сервисы), которые соединяют большие языковые модели с API внешних систем. Spring AI значительно упрощает код, который вам нужно написать для поддержки xref:api/tools.adoc[вызова инструментов].

[[concept-rag]]
### Увеличенное поколение с использованием извлеченияТехника, называемая Retrieval Augmented Generation (RAG), появилась для решения проблемы интеграции релевантных данных в запросы для получения точных ответов от AI-моделей.

Подход включает в себя программную модель обработки в пакетном режиме, где задача считывает неструктурированные данные из ваших документов, преобразует их, а затем записывает в векторную базу данных. На высоком уровне это является ETL (Извлечение, Преобразование и Загрузка) конвейером. Векторная база данных используется в части извлечения техники RAG.

В рамках загрузки неструктурированных данных во векторную базу данных одним из самых важных преобразований является разделение оригинального документа на более мелкие части. Процедура разделения оригинального документа на более мелкие части включает в себя два важных шага:

1. Разделите документ на части, сохраняя семантические границы содержимого. Например, для документа с абзацами и таблицами следует избегать разбиения документа посередине абзаца или таблицы. Для кода избегайте разбиения кода посередине реализации метода.
2. Дальше разделите части документа на части, размер которых составляет небольшую долю от лимита токенов AI-модели.

Следующий этап в RAG — это обработка пользовательского ввода. Когда вопрос пользователя должен быть отвечен AI-моделью, вопрос и все "`похожие`" части документа помещаются в запрос, который отправляется AI-модели. Это причина использования векторной базы данных. Она очень хорошо находит похожий контент.

![Spring AI RAG, width=1000, align="center"](spring-ai-rag.jpg)

- xref::api/etl-pipeline.adoc[ETL Pipeline] предоставляет дополнительную информацию о координации потока извлечения данных из источников данных и их хранении в структурированном векторном хранилище, обеспечивая данные в оптимальном формате для извлечения при передаче их AI-модели.
- xref::api/chatclient.adoc#_retrieval_augmented_generation[ChatClient - RAG] объясняет, как использовать `QuestionAnswerAdvisor`, чтобы включить возможность RAG в ваше приложение.

[[concept-fc]]
### Вызов инструментов

Большие языковые модели (LLMs) замораживаются после обучения, что приводит к устареванию знаний, и они не могут получать доступ или изменять внешние данные.

Механизм xref::api/tools.adoc[Tool Calling] решает эти недостатки. Он позволяет вам регистрировать свои собственные сервисы в качестве инструментов для подключения больших языковых моделей к API внешних систем. Эти системы могут предоставлять LLM реальные данные и выполнять действия по обработке данных от их имени.

Spring AI значительно упрощает код, который вам нужно написать для поддержки вызова инструментов. Он обрабатывает разговор о вызове инструмента за вас. Вы можете предоставить свой инструмент в качестве метода, аннотированного `@Tool`, и включить его в параметры вашего запроса, чтобы сделать его доступным для модели. Кроме того, вы можете определить и ссылаться на несколько инструментов в одном запросе.

![Основная последовательность действий для вызова инструментов, width=700, align="center"](tools/tool-calling-01.jpg)

1. Когда мы хотим сделать инструмент доступным для модели, мы включаем его определение в запрос чата. Каждое определение инструмента состоит из имени, описания и схемы входных параметров.
2. Когда модель решает вызвать инструмент, она отправляет ответ с именем инструмента и входными параметрами, смоделированными по определенной схеме.
3. Приложение отвечает за использование имени инструмента для идентификации и выполнения инструмента с предоставленными входными параметрами.
4. Результат вызова инструмента обрабатывается приложением.
5. Приложение отправляет результат вызова инструмента обратно в модель.
6. Модель генерирует окончательный ответ, используя результат вызова инструмента в качестве дополнительного контекста.

Следуйте документации xref::api/tools.adoc[Tool Calling] для получения дополнительной информации о том, как использовать эту функцию с различными AI-моделями.

[[concept-evaluating-ai-responses]]
## Оценка ответов AIЭффективная оценка выходных данных AI-системы в ответ на запросы пользователей имеет большое значение для обеспечения точности и полезности конечного приложения. Несколько новых методов позволяют использовать сам предобученный модель для этой цели.

Этот процесс оценки включает в себя анализ того, соответствует ли сгенерированный ответ намерениям пользователя и контексту запроса. Метрики, такие как релевантность, согласованность и фактическая правильность, используются для оценки качества ответа, сгенерированного AI.

Один из подходов заключается в том, чтобы представить как запрос пользователя, так и ответ модели AI самой модели, запрашивая, соответствует ли ответ предоставленным данным.

Кроме того, использование информации, хранящейся в векторной базе данных, в качестве дополнительной информации может улучшить процесс оценки, помогая определить релевантность ответа.

Проект Spring AI предоставляет API `Evaluator`, который в настоящее время предоставляет доступ к базовым стратегиям для оценки ответов модели. Следуйте документации xref::api/testing.adoc[Оценка тестирования] для получения дополнительной информации.
